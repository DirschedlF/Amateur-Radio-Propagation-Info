# v1.2.0: Trend-Pfeile, Sturm-Banner, Einstellungen — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Drei unabhängige UI-Features in `PropagationDashboard.jsx` hinzufügen: Trend-Pfeile auf SFI/K-Index, einen dismissbaren Geomagnetsturm-Banner und ein Einstellungs-Modal für Rufzeichen + Locator.

**Architecture:** Alles bleibt in einer einzigen Komponente (`src/PropagationDashboard.jsx`). Trend-Daten und Einstellungen werden in `localStorage` gespeichert. Kein neues Routing, keine neuen Abhängigkeiten — Lucide-React ist bereits im Projekt.

**Tech Stack:** React 18, Vite, Tailwind CSS v3, Lucide-React. Kein Test-Framework vorhanden — Verifikation via `npm run dev` + visueller Prüfung.

**Design-Dokument:** `docs/plans/2026-02-26-trend-arrows-storm-banner-settings-design.md`

---

## Vorbereitung

Vor dem ersten Task:

```bash
cd "D:\!GitHub\Amateur Radio Propagation Info"
git status   # muss sauber sein (nur der Design-Commit)
npm run dev  # Dev-Server auf http://localhost:5173 lassen
```

---

## Task 1: `TrendArrow`-Komponente + Trend-Logik in `refresh()`

**Files:**
- Modify: `src/PropagationDashboard.jsx`

**Kontext:**
Die `BANDS`-Konstante steht in Zeile 23. Sub-Komponenten beginnen ab Zeile 171.
`refresh()` ist ab Zeile 234. Die `setSolar()`-Zuweisung liegt in Zeile 243.

**localStorage-Keys:**
- `prop_prev_sfi` — letzter SFI-Wert (string)
- `prop_prev_kindex` — letzter K-Index-Wert (string)

---

### Schritt 1: `TrendArrow`-Komponente nach `InfoPill` einfügen (nach Zeile 220)

Füge direkt nach der `InfoPill`-Funktion ein:

```jsx
function TrendArrow({ trend }) {
  if (!trend || trend === 'same') return null
  return trend === 'up'
    ? <span className="text-green-400 text-xs font-bold ml-1">↑</span>
    : <span className="text-red-400 text-xs font-bold ml-1">↓</span>
}
```

### Schritt 2: State für Trends in `PropagationDashboard` hinzufügen

In der Komponentenfunktion (nach den bestehenden `useState`-Zeilen, ca. Zeile 229) ergänzen:

```jsx
const [sfiTrend,   setSfiTrend]   = useState(null)
const [kTrend,     setKTrend]     = useState(null)
```

### Schritt 3: Trend-Berechnung am Ende des `try`-Blocks in `refresh()` einfügen

Direkt nach `setLastUpdated(new Date())` (ca. Zeile 245):

```jsx
// Trend-Berechnung
const newSfi = parseInt(solarResult.value.solarflux)
const newKi  = parseInt(solarResult.value.kindex)
const oldSfi = parseInt(localStorage.getItem('prop_prev_sfi'))
const oldKi  = parseInt(localStorage.getItem('prop_prev_kindex'))

if (!isNaN(newSfi) && !isNaN(oldSfi)) {
  setSfiTrend(newSfi > oldSfi ? 'up' : newSfi < oldSfi ? 'down' : 'same')
}
if (!isNaN(newKi) && !isNaN(oldKi)) {
  setKTrend(newKi > oldKi ? 'up' : newKi < oldKi ? 'down' : 'same')
}
if (!isNaN(newSfi)) localStorage.setItem('prop_prev_sfi',    String(newSfi))
if (!isNaN(newKi))  localStorage.setItem('prop_prev_kindex', String(newKi))
```

### Schritt 4: `TrendArrow` in die SFI- und K-Index-MetricCards einbauen

Die `MetricCard` für SFI (ca. Zeile 334) hat kein `children`-Prop. Wir fügen den Pfeil **im Label** an — dazu muss das `label`-Prop ein JSX-Element werden:

```jsx
<MetricCard
  label={<span>Solar Flux (SFI) <TrendArrow trend={sfiTrend} /></span>}
  value={sfi}
  style={sfiStyle(sfi)}
/>
<MetricCard
  label={<span>K-Index (Geomag) <TrendArrow trend={kTrend} /></span>}
  value={ki}
  style={kStyle(ki)}
>
  <KBar value={ki} />
</MetricCard>
```

Gleichzeitig muss `MetricCard` das `label`-Prop als JSX rendern können — das tut es bereits (`{label}` in JSX interpoliert beides). Kein Änderungsbedarf.

### Schritt 5: Visuell prüfen

Browser auf `http://localhost:5173` öffnen. Beim **ersten** Laden: kein Pfeil (kein Vorwert). Dann im Browser-DevTools → Application → localStorage: `prop_prev_sfi` und `prop_prev_kindex` manuell auf einen abweichenden Wert setzen (z.B. `prop_prev_sfi = 100` wenn aktueller Wert > 100 ist). Seite neu laden → Pfeil erscheint.

### Schritt 6: Commit

```bash
git add src/PropagationDashboard.jsx
git commit -m "feat: add trend arrows (↑/↓) for SFI and K-Index"
```

---

## Task 2: Geomagnetsturm-Banner

**Files:**
- Modify: `src/PropagationDashboard.jsx`

**Kontext:**
Der bestehende Fehler-Banner ist ab ca. Zeile 306. Der neue Banner kommt direkt **davor** (also weiter oben im JSX).

---

### Schritt 1: State hinzufügen

Nach den Trend-States (aus Task 1) einfügen:

```jsx
const [stormDismissed, setStormDismissed] = useState(false)
```

### Schritt 2: `setStormDismissed(false)` in `refresh()` zurücksetzen

Am **Anfang** des `refresh()`-Callbacks, direkt nach `setError(null)`:

```jsx
setStormDismissed(false)
```

### Schritt 3: G-Skala-Berechnung als Hilfsvariable im Render-Block

Nach den bestehenden Hilfsvariablen (`sfi`, `ki`, `ai`, …, ca. Zeile 262):

```jsx
const kiNum    = parseInt(ki)
const stormG   = kiNum >= 5 ? kiNum - 4 : 0
const showStorm = !stormDismissed && stormG > 0
```

### Schritt 4: Banner-JSX vor dem Fehler-Banner einfügen

Direkt vor dem `{error && (…)}`-Block:

```jsx
{/* ── Sturm-Banner ── */}
{showStorm && (
  <div className="flex items-start gap-3 bg-red-950/70 border border-red-700 rounded-xl p-4">
    <span className="text-red-400 text-xl leading-none shrink-0">⚡</span>
    <div className="flex-1">
      <p className="text-sm text-red-200 font-semibold">
        Geomagnetsturm G{stormG} aktiv (K={ki}) — HF-Ausbreitung stark gestört
      </p>
      <p className="text-xs text-red-400 mt-0.5">
        Hohe Bänder (17–10 m) sind wahrscheinlich gestört. Tiefere Bänder prüfen.
      </p>
    </div>
    <button
      onClick={() => setStormDismissed(true)}
      className="text-red-400 hover:text-red-200 transition-colors shrink-0 text-lg leading-none"
      aria-label="Banner schließen"
    >
      ×
    </button>
  </div>
)}
```

### Schritt 5: Visuell prüfen

Im Browser DevTools → Console temporär testen:

```js
// Simuliert hohen K-Index ohne echten API-Abruf
// Einfach im localStorage den prev_kindex setzen und schauen ob Banner erscheint
// Alternativ: in den Render-Code temporär showStorm=true hardcoden zum Prüfen
```

Kontrolle:
- Banner erscheint wenn `showStorm = true` hardcoded
- `×`-Button lässt ihn verschwinden
- Nach manuellem Refresh (Button) kommt er zurück
- Entferne temporären Hardcode danach wieder

### Schritt 6: Commit

```bash
git add src/PropagationDashboard.jsx
git commit -m "feat: add dismissable geomagnetic storm banner (K >= 5)"
```

---

## Task 3: Einstellungen-Modal (Rufzeichen + Locator)

**Files:**
- Modify: `src/PropagationDashboard.jsx`

**Kontext:**
Header-Bereich ab ca. Zeile 273. Import-Zeile ist Zeile 2 (`RefreshCw, Radio, AlertCircle, ChevronDown, ChevronUp`). `PROP_LINKS` ist ab Zeile 12.

---

### Schritt 1: Lucide `Settings`-Icon zum Import hinzufügen

Zeile 2 anpassen:

```jsx
import { RefreshCw, Radio, AlertCircle, ChevronDown, ChevronUp, Settings } from 'lucide-react'
```

### Schritt 2: State für Modal + Einstellungen initialisieren

In der Komponentenfunktion, nach den Trend-States:

```jsx
const [showSettings,   setShowSettings]   = useState(false)
const [callsign,       setCallsign]       = useState(() => localStorage.getItem('prop_callsign')  ?? '')
const [locator,        setLocator]        = useState(() => localStorage.getItem('prop_locator')   ?? '')
const [draftCallsign,  setDraftCallsign]  = useState('')
const [draftLocator,   setDraftLocator]   = useState('')
```

### Schritt 3: `resolveLinks`-Hilfsfunktion nach `PROP_LINKS` einfügen (nach Zeile 19)

```jsx
function resolveLinks(locator) {
  if (!locator || locator.length < 4) return PROP_LINKS
  return PROP_LINKS.map(l => ({
    ...l,
    url: l.url.replace('JN58TC', locator.toUpperCase()),
  }))
}
```

### Schritt 4: Einstellungen öffnen — Draft-Werte setzen

Handler in der Komponentenfunktion:

```jsx
const openSettings = () => {
  setDraftCallsign(callsign)
  setDraftLocator(locator)
  setShowSettings(true)
}

const saveSettings = () => {
  const cs  = draftCallsign.toUpperCase().trim()
  const loc = draftLocator.toUpperCase().trim()
  setCallsign(cs)
  setLocator(loc)
  localStorage.setItem('prop_callsign', cs)
  localStorage.setItem('prop_locator',  loc)
  setShowSettings(false)
}
```

### Schritt 5: Settings-Icon-Button im Header einbauen

Im Header, in der `flex items-center gap-3`-Gruppe (ca. Zeile 285), **vor** dem Refresh-Button:

```jsx
<button
  onClick={openSettings}
  className="p-1.5 rounded-lg text-gray-400 hover:text-gray-200 hover:bg-gray-800 transition-colors"
  aria-label="Einstellungen"
>
  <Settings className="w-4 h-4" />
</button>
```

### Schritt 6: Modal-JSX ans Ende des Returns einfügen (direkt vor dem schließenden `</div>` des Root-Elements)

```jsx
{/* ── Einstellungen-Modal ── */}
{showSettings && (
  <div
    className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    onClick={() => setShowSettings(false)}
  >
    <div
      className="bg-gray-900 border border-gray-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl"
      onClick={e => e.stopPropagation()}
    >
      <h2 className="text-lg font-semibold text-gray-100 mb-5">Einstellungen</h2>

      <div className="space-y-4">
        <div>
          <label className="block text-xs font-medium text-gray-400 mb-1.5 uppercase tracking-wider">
            Rufzeichen
          </label>
          <input
            type="text"
            value={draftCallsign}
            onChange={e => setDraftCallsign(e.target.value.toUpperCase())}
            placeholder="z.B. DL1ABC"
            className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-blue-500 font-mono uppercase"
          />
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-400 mb-1.5 uppercase tracking-wider">
            Maidenhead-Locator
          </label>
          <input
            type="text"
            value={draftLocator}
            onChange={e => setDraftLocator(e.target.value.toUpperCase().slice(0, 6))}
            placeholder="z.B. JN58TC"
            maxLength={6}
            className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-blue-500 font-mono uppercase"
          />
          <p className="text-[11px] text-gray-600 mt-1">
            Wird für DXView-Link verwendet
          </p>
        </div>
      </div>

      <div className="flex gap-3 mt-6">
        <button
          onClick={saveSettings}
          className="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium transition-colors"
        >
          Speichern
        </button>
        <button
          onClick={() => setShowSettings(false)}
          className="flex-1 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm font-medium text-gray-300 transition-colors"
        >
          Abbrechen
        </button>
      </div>
    </div>
  </div>
)}
```

### Schritt 7: `resolveLinks` in den Propagations-Links-Block einsetzen

Den bestehenden `PROP_LINKS.map(…)` im Render (ca. Zeile 439) ersetzen durch:

```jsx
{resolveLinks(locator).map(({ name, desc, url }) => (
  // … rest unverändert
))}
```

### Schritt 8: Visuell prüfen

- Zahnrad erscheint im Header
- Klick öffnet Modal
- Klick auf Overlay schließt Modal
- Rufzeichen + Locator eingeben, Speichern — Felder bleiben nach Reload
- "Propagations-Links" öffnen → DXView-URL enthält eigenen Locator statt `JN58TC`
- Locator leer lassen → DXView-Link bleibt bei `JN58TC`

### Schritt 9: Commit

```bash
git add src/PropagationDashboard.jsx
git commit -m "feat: add settings modal for callsign and Maidenhead locator"
```

---

## Task 4: Version + Abschluss

**Files:**
- Modify: `src/PropagationDashboard.jsx` (Zeile 6)
- Modify: `package.json`
- Modify: `README.md`

### Schritt 1: Version auf 1.2.0 setzen

`src/PropagationDashboard.jsx` Zeile 6:
```jsx
const APP_VERSION = '1.2.0'
```

`package.json`:
```json
"version": "1.2.0"
```

`README.md`: Version-Badge / Headerzeile aktualisieren (suche nach `1.1.0`).

### Schritt 2: Build prüfen

```bash
npm run build
```

Erwartete Ausgabe: `dist/` ohne Fehler. Warnungen zu Bundle-Größe sind OK.

### Schritt 3: Commit + Tag

```bash
git add src/PropagationDashboard.jsx package.json README.md
git commit -m "chore: bump version to 1.2.0"
git tag v1.2.0
git push origin master
git push origin v1.2.0
```

GitHub Actions baut dann automatisch die Standalone-HTML.

---

## Checkliste Gesamttest

Vor dem Tag alles durchprüfen:

- [ ] Kein `localStorage`-Eintrag vorhanden → keine Trend-Pfeile beim ersten Laden
- [ ] Nach einem Refresh: Pfeile erscheinen sobald Vorwert da ist
- [ ] SFI und K-Index zeigen korrekte Richtung
- [ ] Sturm-Banner erscheint bei K ≥ 5 (manuell mit hardcode testen, dann revertieren)
- [ ] `×`-Button schließt Banner
- [ ] Refresh bringt Banner zurück (wenn K noch hoch)
- [ ] Zahnrad-Icon im Header vorhanden
- [ ] Modal öffnet/schließt korrekt (Button + Overlay-Klick)
- [ ] Einstellungen überleben Seiten-Reload (localStorage)
- [ ] DXView-Link enthält eigenen Locator nach Speichern
- [ ] DXView-Link bei leerem Locator = `JN58TC` (kein `undefined` in URL)
- [ ] `npm run build` ohne Fehler
